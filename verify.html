<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ENS Club Verification</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 40px auto;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            font-size: 1.1rem;
            background: #4cafef;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            font-weight: bold;
        }
        .error {
            color: #d33;
        }
        .success {
            color: #2c9c2c;
        }
    </style>
</head>
<body>
    <h2>ENS Club Verification</h2>
    <p>Click below to connect MetaMask and verify your wallet.</p>
    <button id="verifyBtn">Verify with MetaMask</button>
    <div class="status" id="status"></div>

    <script>
        const queryParams = new URLSearchParams(window.location.search);
        const discordId = queryParams.get("id");
        const verifyBtn = document.getElementById("verifyBtn");
        const statusDiv = document.getElementById("status");

        if (!discordId) {
            statusDiv.innerHTML = "<span class='error'>Missing Discord ID in URL</span>";
            verifyBtn.disabled = true;
        }

        async function verifyWallet() {
            try {
                if (!window.ethereum) {
                    statusDiv.innerHTML = "<span class='error'>MetaMask not detected</span>";
                    return;
                }

                verifyBtn.disabled = true;
                statusDiv.textContent = "Connecting to MetaMask...";

                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                const address = accounts[0];

                // Step 1: Request nonce from server
                const nonceRes = await fetch(`/request-nonce?discordId=${discordId}`);
                if (!nonceRes.ok) throw new Error("Failed to get nonce");
                const { message } = await nonceRes.json();

                // Step 2: Sign nonce
                statusDiv.textContent = "Please sign the message in MetaMask...";
                const signature = await ethereum.request({
                    method: 'personal_sign',
                    params: [message, address]
                });

                // Step 3: Send signature to server
                statusDiv.textContent = "Verifying ownership...";
                const sigRes = await fetch(`/submit-signature`, {
                    method: 'POST',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        discordId,
                        address,
                        signature
                    })
                });

                const sigData = await sigRes.json();

                if (sigRes.ok && sigData.ok) {
                    statusDiv.innerHTML = `<span class='success'>✅ Verified! You now have access in Discord.</span>`;
                } else {
                    throw new Error(sigData.error || "Verification failed");
                }

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = `<span class='error'>❌ ${err.message}</span>`;
            } finally {
                verifyBtn.disabled = false;
            }
        }

        verifyBtn.addEventListener("click", verifyWallet);
    </script>
</body>
</html>
